---
title: "work_OD"
author: "Kenneth Wong"
date: "12/28/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(networkD3)
library(ggalluvial)
library(plotly)
```


```{r}
work_OD = read_csv("data/data-edited/work_OD_clean.csv") %>%
  rename(
    "place_of_residence" = "Place of residence",
    "place_of_work" = "Place of Work",
    "N_workers" = "Number of Persons"
  )
```

# Add categorial variables

```{r}
work_OD_order = work_OD %>%
  mutate(
    residence_area = case_when(
      place_of_residence %in% c("Central and Western", "Wan Chai", "Eastern", "Southern") ~ "HKI",
      place_of_residence %in% c("Yau Tsim Mong", "Sham Shui Po", "Kowloon City", "Wong Tai Sin", "Kwun Tong") ~ "KL",
      place_of_residence %in% c("Kwai Tsing", "Tsuen Wan", "Tuen Mun", "Yuen Long") ~ "NTW",
      place_of_residence %in% c("North", "Tai Po", "Sha Tin", "Sai Kung") ~ "NTE",
      place_of_residence %in% c("Islands") ~ "I",
    )
  )
```


```{r}
# Needs to classify origin and dest as different nodes, even the place of work is same as place of residences
# Add an ending space character to differentiate between origin and dest
work_OD_differentiate = work_OD_order %>%
  mutate(place_of_work_e = paste0(place_of_work, " "))

# drop factor levels
origin_list = as.character(unique(work_OD_differentiate$place_of_residence)) 
destination_list = unique(work_OD_differentiate$place_of_work_e)

# Create node ID including all origin and destination nodes
nodes_OD = data.frame(node_name = c(origin_list, destination_list)) %>%
  unique() %>%
  mutate(node_ID = seq.int(nrow(.)) - 1) # Source/Target needs to be zero-indexed for sankeyNetwork.

```

## Refactor district order

```{r}
DISTRICT_ORDER = c("Central and Western", "Wan Chai", "Eastern", "Southern", "Yau Tsim Mong", "Sham Shui Po", "Kowloon City", "Wong Tai Sin", "Kwun Tong", "Kwai Tsing", "Tsuen Wan", "Tuen Mun", "Yuen Long", "North", "Tai Po", "Sha Tin", "Sai Kung", "Islands")

WORKPLACE_ORDER = c("Central and Western", "Wan Chai", "Eastern", "Southern", "Yau Tsim Mong", "Sham Shui Po", "Kowloon City", "Wong Tai Sin", "Kwun Tong", "Kwai Chung New Town", "Tsuen Wan New Town", "Tsing Yi New Town", "Tuen Mun New Town", "Tin Shui Wai New Town", "Yuen Long New Town", "Fanling/ Sheung Shui New Town", "Tai Po New Town", "Sha Tin New Town", "Ma On Shan New Town", "Tseung Kwan O New Town", "North Lantau New Town", "Other areas in the New Territories", "No fixed places of work in Hong Kong/ Marine/ Work at home/ Places outside Hong Kong")
```

```{r}
work_OD_plot = work_OD_differentiate %>%
  left_join(nodes_OD, by = c("place_of_residence" = "node_name")) %>%
  rename("origin_ID" = "node_ID") %>%
  left_join(nodes_OD, by = c("place_of_work_e" = "node_name")) %>%
  rename("destination_ID" = "node_ID") 

```

```{r}
# Reorder has to be done after join?
work_OD_plot_reorder = work_OD_plot %>% 
  mutate(
    place_of_residence = factor(place_of_residence, DISTRICT_ORDER),
    place_of_work = factor(place_of_work, WORKPLACE_ORDER)
  )

work_OD_plot_reorder_rmspecial = work_OD_plot_reorder %>%
  subset(place_of_work != "No fixed places of work in Hong Kong/ Marine/ Work at home/ Places outside Hong Kong")

work_OD_plot_reorder_KT = work_OD_plot_reorder %>%
  subset(place_of_work == "Kwun Tong")
```

## ggalluvial

```{r}
OD_work_alluvial = ggplot(work_OD_plot_reorder_rmspecial, aes(y = N_workers, axis1 = place_of_residence, axis2 = place_of_work)) +
  geom_alluvium(aes(fill = residence_area), width = .2, alpha = .4) +
  geom_stratum(width = .2, fill = "#EEEEEE", color = "#FFFFFF") +
  # http://corybrunson.github.io/ggalluvial/reference/stat_stratum.html
  # https://stackoverflow.com/questions/29465941/format-number-in-r-with-both-comma-thousands-separator-and-specified-decimals
  geom_text(stat = "stratum", aes(label = paste0(after_stat(stratum), " -\n", after_stat(format(count, big.mark=",")))), size = 2) +
  scale_x_discrete(limits = c("Place of \nResidence", "Place of \nWork"), expand = c(.05, .05), position = "top") +
  scale_fill_brewer(type = "qual", palette = "Set1") +
  theme_void() +
  theme(
    axis.text.x = element_text(size = 12),
    legend.position = "None",
    aspect.ratio = 3/1
  ) +
  labs(
    title = "Flow of commuters",
    subtitle = "Place of residence and work of commuters in Hong Kong",
    caption = "Note: workers with no fixed places of work or \nwork in Marine/at home/in places outside Hong Kong are excluded."
  )

OD_work_alluvial
```
```{r}
ggsave("OD_work_alluvial.svg", width = 150, height = 450, units = "mm")
```


## Sankey Network

```{r}
nodes_OD_KT = nodes_OD %>% subset(node_ID <= 17 | node_ID == 26) %>%
  dplyr::select(node_name) %>%
  as.data.frame()

work_OD_plot_reorder_KT_char = work_OD_plot_reorder_KT %>%
  mutate(place_of_residence_e = as.character(place_of_residence)) %>%
  rename(
    source = place_of_residence_e,
    target = place_of_work_e,
    value = N_workers,
    IDsource = origin_ID,
    IDtarget = destination_ID
  ) %>%
  dplyr::select(-place_of_residence, place_of_work, residence_area) %>%
  as.data.frame()

```


```{r}

# Make the Network
sankeyNetwork(Links = work_OD_plot_reorder_KT_char, Nodes = nodes_OD_KT,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "node_name", 
              sinksRight = FALSE)
```


```{r}
# Load dataset from github
data <- read.table("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/13_AdjacencyDirectedWeighted.csv", header=TRUE)


# I need a long format
data_long <- data %>%
  rownames_to_column %>%
  gather(key = 'key', value = 'value', -rowname) %>%
  filter(value > 0)
colnames(data_long) <- c("source", "target", "value")
data_long$target <- paste(data_long$target, " ", sep="")

# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame(name=c(as.character(data_long$source), as.character(data_long$target)) %>% unique())
 
# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
data_long$IDsource=match(data_long$source, nodes$name)-1 
data_long$IDtarget=match(data_long$target, nodes$name)-1

# prepare colour scale
ColourScal ='d3.scaleOrdinal() .range(["#FDE725FF","#B4DE2CFF","#6DCD59FF","#35B779FF","#1F9E89FF","#26828EFF","#31688EFF","#3E4A89FF","#482878FF","#440154FF"])'

# Make the Network
sankeyNetwork(Links = data_long, Nodes = nodes,
                     Source = "IDsource", Target = "IDtarget",
                     Value = "value", NodeID = "name", 
                     sinksRight=FALSE, colourScale=ColourScal, nodeWidth=40, fontSize=13, nodePadding=20)
```

```{r}
work_OD_plot_reorder_KT_char
```

```{r}
nodes_OD_KT[["node_name"]]

work_OD_plot_reorder_KT_char[["IDsource"]]

work_OD_plot_reorder_KT_char[["IDtarget"]]

work_OD_plot_reorder_KT_char[["value"]]
```

```{r}
library(RColorBrewer)
brewer.pal(n = 5, "Set1")
```


```{r}
# add colour code for links
work_OD_plot_reorder_plotly = work_OD_plot_reorder %>%
  mutate(
    link_colour = case_when(
      residence_area == "HKI" ~ "#E41A1C33",
      residence_area == "KL" ~ "#4DAF4A33",
      residence_area == "NTW" ~ "#FF7F0033",
      residence_area == "NTE" ~ "#984EA333",
      residence_area == "I" ~ "#377EB833"
    )
  )

work_OD_plot_reorder_plotly_rmspecial = work_OD_plot_reorder_plotly %>%
  subset(place_of_work != "No fixed places of work in Hong Kong/ Marine/ Work at home/ Places outside Hong Kong")

work_OD_plot_reorder_plotly_KT = work_OD_plot_reorder_plotly %>%
  subset(place_of_work == "Kwun Tong")

work_OD_plot_reorder_plotly_fromHKI = work_OD_plot_reorder_plotly %>%
  subset(residence_area == "HKI")


```

```{r}
node_y = c(seq(.01, 1, length.out = length(DISTRICT_ORDER)), seq(.01, 1, length.out	= length(WORKPLACE_ORDER)))

# nudged x-axis position for plotly
node_x_nudge = c(seq(0.01, length.out = length(DISTRICT_ORDER), by = 0.01), rev(seq(1, length.out = length(WORKPLACE_ORDER), by = -0.01)))

nodes_OD_wposition = nodes_OD %>%
  bind_cols(
    node_y = node_y,
    node_x_nudge = node_x_nudge) %>%
  mutate(node_x = ifelse(node_ID <= 17, 0, 1))
  
```



```{r}
fig <- plot_ly(
    type = "sankey",
    orientation = "h",

    node = list(
      label = nodes_OD_wposition[["node_name"]],
      x = nodes_OD_wposition[["node_x"]],
      y = nodes_OD_wposition[["node_y"]],
      color = "#666666",
      pad = 15,
      thickness = 20,
      line = list(
        color = "black",
        width = 0.5
      )
    ),

    link = list(
      source = work_OD_plot_reorder_plotly[["origin_ID"]],
      target = work_OD_plot_reorder_plotly[["destination_ID"]],
      value = work_OD_plot_reorder_plotly[["N_workers"]],
      color = work_OD_plot_reorder_plotly[["link_colour"]]
      # color = "#00FF00"

    )
  )

fig <- fig %>% layout(
    title = "Basic Sankey Diagram",
    font = list(
      size = 10
    )
)

fig
```

```{r}
fig_rmspecial <- plot_ly(
    type = "sankey",
    orientation = "h",

    node = list(
      label = nodes_OD[["node_name"]],
      color = "#666666",
      pad = 15,
      thickness = 20,
      line = list(
        color = "black",
        width = 0.5
      )
    ),

    link = list(
      source = work_OD_plot_reorder_plotly_rmspecial[["origin_ID"]],
      target = work_OD_plot_reorder_plotly_rmspecial[["destination_ID"]],
      value = work_OD_plot_reorder_plotly_rmspecial[["N_workers"]],
      color = work_OD_plot_reorder_plotly_rmspecial[["link_colour"]]
      # color = "#00FF00"

    )
  )

fig_rmspecial <- fig_rmspecial %>% layout(
    title = "Basic Sankey Diagram",
    font = list(
      size = 10
    )
)

fig_rmspecial
```

```{r}
nodes_OD_fromHKI = nodes_OD_wposition %>%
  filter(node_ID <=3 | (node_ID >= 18)) %>%
  mutate(node_ID = ifelse(node_ID <=3 , node_ID, node_ID - 14))

work_OD_plot_reorder_plotly_fromHKI_increID = work_OD_plot_reorder_plotly_fromHKI %>%
  mutate(destination_ID = destination_ID - 14)
```

```{r}

fig_fromHKI <- plot_ly(
    type = "sankey",
    arrangement = "snap",
    orientation = "h",

    node = list(
      label = nodes_OD_fromHKI[["node_name"]],
      # x = nodes_OD_fromHKI[["node_x"]],
      # y = nodes_OD_fromHKI[["node_y"]],
      color = "#666666",
      pad = 15,
      thickness = 20,
      line = list(
        color = "black",
        width = 0.5
      )
    ),

    link = list(
      source = work_OD_plot_reorder_plotly_fromHKI_increID[["origin_ID"]],
      target = work_OD_plot_reorder_plotly_fromHKI_increID[["destination_ID"]],
      value = work_OD_plot_reorder_plotly_fromHKI_increID[["N_workers"]],
      color = work_OD_plot_reorder_plotly_fromHKI_increID[["link_colour"]]
      # color = "#00FF00"

    )
  )

fig_fromHKI_layout <- fig_fromHKI %>% layout(
    title = "Basic Sankey Diagram",
    font = list(
      size = 10
    )
)

fig_fromHKI_layout
```

```{r}
nodes_OD_fromtoHKI = nodes_OD_wposition %>%
  filter(node_ID <=3 | (node_ID >= 18 & node_ID <= 21))

work_OD_plot_reorder_plotly_fromtoHKI = work_OD_plot_reorder_plotly %>%
  dplyr::filter(residence_area == "HKI" & (destination_ID >= 18 & destination_ID <= 21) )
```


```{r}

fig_fromtoHKI <- plot_ly(
    type = "sankey",
    arrangement = "snap",
    orientation = "h",

    node = list(
      label = nodes_OD_wposition[["node_name"]],
      x = nodes_OD_wposition[["node_x"]],
      y = nodes_OD_wposition[["node_y"]],
      color = "#666666",
      pad = 15,
      thickness = 20,
      line = list(
        color = "black",
        width = 0.5
      )
    ),

    link = list(
      source = work_OD_plot_reorder_plotly_fromtoHKI[["origin_ID"]],
      target = work_OD_plot_reorder_plotly_fromtoHKI[["destination_ID"]],
      value = work_OD_plot_reorder_plotly_fromtoHKI[["N_workers"]],
      color = work_OD_plot_reorder_plotly_fromtoHKI[["link_colour"]]
      # color = "#00FF00"

    )
  )

fig_fromtoHKI_layout <- fig_fromtoHKI %>% layout(
    title = "Basic Sankey Diagram",
    font = list(
      size = 10
    )
)

fig_fromtoHKI_layout
```


```{r}
library(plotly)
fig <- plot_ly(
  type = "sankey",
  arrangement = "snap",
  node = list(
    label = c("A", "B", "C", "D", "E", "F"),
    x = c(0.2, 0.1, 0.5, 0.7, 0.3, 0.5),
    y = c(0.7, 0.5, 0.2, 0.4, 0.2, 0.3),
    pad = 10), # 10 Pixel
  link = list(
    source = c(0, 0, 1, 2, 5, 4, 3, 5),
    target = c(5, 3, 4, 3, 0, 2, 2, 3),
    value = c(1, 2, 1, 1, 1, 1, 1, 2)))
fig <- fig %>% layout(title = "Sankey with manually positioned node")

fig
```



```{r}
work_OD_plot_reorder_plotly_toKT = work_OD_plot_reorder_plotly %>%
  subset(place_of_work == "Kwun Tong")
```

```{r}

fig_toKT <- plot_ly(
    type = "sankey",
    arrangement = "snap",
    orientation = "h",

    node = list(
      label = nodes_OD_wposition[["node_name"]],
      x = nodes_OD_wposition[["node_x_nudge"]],
      y = nodes_OD_wposition[["node_y"]],
      color = "#666666",
      pad = 15,
      thickness = 20,
      line = list(
        color = "black",
        width = 0.5
      )
    ),

    link = list(
      source = work_OD_plot_reorder_plotly_toKT[["origin_ID"]],
      target = work_OD_plot_reorder_plotly_toKT[["destination_ID"]],
      value = work_OD_plot_reorder_plotly_toKT[["N_workers"]],
      color = work_OD_plot_reorder_plotly_toKT[["link_colour"]]
      # color = "#00FF00"

    )
  )

fig_toKT_layout <- fig_toKT %>% layout(
    title = "Basic Sankey Diagram",
    font = list(
      size = 10
    )
)

fig_toKT_layout
```







```{r}

fig_test <- plot_ly(
    type = "sankey",
    arrangement = "snap",
    orientation = "h",

    node = list(
      label = c("A", "B", "C", "D", "E", "F", "G", "H"),
      x = c(0, 0.01, 0, 0, 1, 1, 1, 1),
      y = c(0, .33, .66, 1, 0, .33, .66, 1),
      pad = 10
    ),

    link = list(
      source = c(0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3, 0, 1, 2, 3),
      target = c(4, 4, 4, 4, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7, 7),
      value = c(48647, 19244, 42452, 24074, 12938, 21861, 37655, 16625, 8161, 8735, 65803, 8887, 4793, 2503, 8398, 28882)
    )
  )

fig_test <- fig_test %>% layout(
    title = "Basic Sankey Diagram",
    font = list(
      size = 10
    )
)

fig_test
```

